# Selenium: поднять за 60 секунд
[Selenium](http://seleniumhq.org/) сегодня является стандартом де-факто для автоматизации выполнения тестов в браузерах. Все популярные браузеры поддерживаются из коробки, а архитектура хорошо известна. Существуют даже компании, предоставляющие Selenium за деньги. Но удобен ли обычный Selenium сервер для локальной отладки тестов?

## Проблема
Как веб-разработчик или инженер по автоматизации тестирования вы можете столкнуться со следующими неудобствами при работе со стандартным Selenium сервером:
1) Нужно устаналивать несколько разных браузеров себе на компьютер. В обычной жизни вы как правило используете один браузер, например, Chrome. Но вам приходится устанавливать себе Firefox и Opera, чтобы отлаживать в них Selenium-тесты.
2) Трудно устанавливать и использовать несколько версий одного браузера. Если вы устанавливаете браузер из пакетов, то вообще можно иметь только одну установленную версию. Кроме того Selenium и его веб-драйверы обычно ищут исполняемый файл браузера по определенному пути. Поэтому, поверьте, использовать несколько версий может быть трудной задачей.
3) Если вы запускаете браузер, установленный в вашей операционной системе - он забивает место на диске своими временными файлами и содержимым кеша.
4) Кроме того нельзя гарантировать, что настройки браузера всегда останутся в том же состоянии, как после чистой установки. Например, вы можете случайно изменить адрес прокси-сервера или настройки безопасности. Это может привести к падению ранее работавших тестов.
5) Трудно запускать несколько тестов в разных браузерах параллельно. Попытка сделать это как правило приводит к различным проблемам с фокусом окна (окна начинают конкурировать за фокус): не срабатывающие события, не ожидаемые CSS стили и так далее.
6) Нужно знать какая версия Selenium совместима с какой версией браузера. То же самое верно для исполняемых файлов веб-драйверов (например, Chromedriver).
Приведенный выше список недостатков далеко не полный. Но давайте остановимся на этом и попробуем гораздо более удобный способ отладки Selenium-тестов локально. 

## Selenoid
В моей предыдущей статье ([часть I](https://hackernoon.com/selenium-testing-a-new-hope-7fa87a501ee9), [часть II](https://hackernoon.com/selenium-testing-a-new-hope-a00649cdb100)) я коротко описал новые бесплатные инструменты для работы с Selenium: [Ggr](http://github.com/aerokube/ggr) и [Selenoid](http://github.com/aerokube/selenoid). **Ggr** в основном нужен для больших Selenium кластеров и не нужен для отладки тестов на вашей машине. Сегодня я более подробно расскажу о **Selenoid** - альтернативной реализации Selenium хаба, которая запускает браузеры в [Docker](http://docker.io/) контейнерах.

Но почему же запуск браузеров в контейнерах так удобен? И в чем разница между запуском браузеров из контейнеров, поставляемых разработчиками Selenium и Selenoid? - Основная идея Selenoid состоит в том, чтобы запускать новый контейнер для каждой Selenium сессии (т.е. запроса нового браузера) и останавливать их сразу же после закрытия сессии. Такой подход сразу же решает все проблемы связанные с залипанием состояния в кешах и использования одних настроек браузера в разных сессиях. В каждом контейнере находится конкретная версия браузера, правильная версия веб-драйвера или Selenium сервера, поддерживающая этот браузер и все зависимости наподобие шрифтов, графических библиотек и так далее. Кроме того контейнеры дают достаточный уровень изоляции процессов браузеров. Это позволяет запускать неограниченное количество разлиных версий браузеров параллельно и забыть о проблемах с фокусом. Безусловно, эти же проблемы решаются и обычными Selenium контейнерами. Но для того, чтобы получить поведение, аналогичное Selenoid, в дополнение к Docker как правило требуется использовать сложные админские инструменты наподобие [Ansible](http://ansible.com) или [Salt](http://saltstack.com/).

## Установка
Немного порекламировав Selenoid, настало время показать как просто с ним работать. Для того, чтобы получить работающий Selenium нужно выполнить 3 коротких шага:

1) Установить [Docker](http://docker.com/). Обычно это делается при помощи стандартного менеджера пакетов вашей операционной системы такого как [APT](https://wiki.debian.org/Apt), [Yum](https://fedoraproject.org/wiki/Yum) или [Homebrew](http://brew.sh). Подробности можно найти в [документации](https://docs.docker.com/engine/installation/) Docker.
2) Создать каталог для хранения конфигурации Selenoid и сгенерировать файл конфигурации:
```
# mkdir -p /etc/selenoid
# docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aerokube/cm:1.0.0 selenoid --last-versions 2 --tmpfs 128 --pull > /etc/selenoid/browsers.json
```
Последняя команда также скачает образы Docker-контейнеров двух последних версий Firefox, Chrome и Opera и сгенерирует правильный файл конфигурации для Selenoid.
3) Запустить Selenoid:
```
# docker run -d --name selenoid -p 4444:4444 -v /etc/selenoid:/etc/selenoid:ro -v /var/run/docker.sock:/var/run/docker.sock aerokube/selenoid:1.1.1
```
Все - Selenoid готов к работе за 60 секунд. Больше не нужно ставить Java и скачивать файлы Selenium руками. Просто запустите свои тесты, используя тот же самый URL, что и у обычного Selenium server:
```
http://localhost:4444/wd/hub
```

## Мордочка и сбор статистики
Selenoid может использоваться совместно с Ggr для настройки большого Selenium кластера, поэтому у него нет графического интерфейса наподобие Grid Console в обычном Selenium. Посмотреть потребление браузеров можно двумя способами:
1) Запустить дополнительный легковесный контейнер с Selenoid UI. Это делается командой:
```
# docker run -d --name selenoid-ui --net host aerokube/selenoid-ui:1.0.0
```
Мордочка будет доступна в браузере по адресу ```http://localhost:8080/```:

2) Отправлять статистику Selenoid во внешнюю систему: [Graphite](https://github.com/graphite-project/), [InfluxDB](https://github.com/influxdata/influxdb), [ElasticSearch](https://github.com/elastic/elasticsearch) и так далее. Статистика Selenoid может быть получена по следующему URL:
```
http://localhost:4444/status
```
Данные отправляются в виде JSON следующего формата:
```json
  $ curl http://localhost:4444/status
  {
    "total": 80,
    "used": 0,
    "queued": 0,
    "pending": 1,
    "browsers": {
      "firefox": {
        "46.0": {
          "user1": 5,
          "user2": 6
        },
        "48.0": {
          "user2": 3
        }
      }
    }
  }
```
Selenoid возвращает сколько контейнеров может быть запущено одновременно (**total**), сколько запущено в данный момент (**used**), сколько запросов ожидают в очереди (**queued**) и сколько контейнеров уже стартуют (**pending**). Элемент **browsers** содержит информацию о потреблении браузеров различными пользователями. Имя пользователя извлекается из Basic HTTP headers, если они выставлены или выставляется в **unknown**, если нет. Хотя вы можете разбирать показанный JSON вручную при помощи скрипта, мы рекомендуем использовать для этой цели [Telegraf](http://github.com/influxdata/telegraf/). Больше информации о том, как использовать Telegraf изложено в [этом](https://github.com/aerokube/selenoid#sending-statistics-to-external-systems) разделе нашей документации.

## Готовые контейнеры с браузерами
Согласитесь, круто иметь инструмент, автоматически запускающий контейнеры с разными браузерами. Но еще круче иметь набор готовых контейнеров с разными версиями популярных браузеров. Мы проделали много работы и подготовили образы контейнеров с разными версиями Firefox, Chrome и Opera. Полный список можно посмотреть на [selenoid@DockerHub](http://hub.docker.com/u/selenoid/).

Чтобы всегда иметь набор свежих версий браузеров нужно лишь время от времени выполнять команду:
```
# docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aerokube/cm:1.0.0 selenoid --last-versions 2 --tmpfs 128 --pull > /etc/selenoid/browsers.json
```
Эта команда автоматически скачивает последние версии контейнеров и генерирует новую JSON-конфигурацию для Selenoid. Чтобы начать использовать новые браузеры отправьте Selenoid команду на перечитывание конфигурации (можно делать под нагрузкой):
```
# docker kill -s HUP selenoid
```
Наши контейнеры также поддерживают возможность установки произвольно разрешения экрана (по-умолчанию ```1920x1080x24```). Чтобы выставить разрешение просто передайте capability ```screenResolution```:
```
screenResolution: 1280x1024x24
```

## Заключение
В этой статье я рассказал как эффективно управлять различными браузерами при помощи Selenium. Поверьте - работа с Selenium может быть комфортной. Если вам интересны вопросы построения эффективной инфраструктуры тестирования, вы можете взглянуть на другие бесплатные инструменты в нашей организации на [Github](http://github.com/aerokube) или подпишитесь на наш Твиттер [@aerokube](http://twitter.com/aerokube).
